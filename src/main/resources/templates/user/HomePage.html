<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chu - TechShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Ẩn scrollbar ngang cho track danh mục */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Hiển thị rõ viền khi chọn danh mục */
        .category-card.active { border-color: #f97316; box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.35); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- Header fragment -->
<div th:replace="~{user/Fragment/Header :: header}"></div>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb & Search Info (chỉ hiển thị khi tìm kiếm) -->
    <div th:if="${isSearchMode}" class="mb-6">
        <nav class="flex items-center gap-2 text-sm text-gray-600 mb-4">
            <a href="/user/home" class="hover:text-orange-600">Trang chủ</a>
            <i class="fas fa-chevron-right text-xs"></i>
            <span class="text-gray-900 font-semibold">Kết quả tìm kiếm</span>
        </nav>
        <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
            <h1 class="text-2xl font-bold text-gray-900 mb-1">Kết quả tìm kiếm cho "<span th:text="${searchKeyword}" class="text-orange-600">từ khóa</span>"</h1>
            <p class="text-sm text-gray-600">Tìm thấy <span th:text="${sizeProducts}" class="font-semibold text-gray-900">0</span> sản phẩm</p>
        </div>
    </div>

    <!-- Hero banner Carousel -->
    <section th:unless="${isSearchMode}" class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-slate-900 via-slate-800 to-gray-900 text-white shadow-xl">
        <div class="absolute inset-0 opacity-30">
            <div class="absolute -left-10 top-10 w-56 h-56 bg-orange-500 rounded-full blur-3xl"></div>
            <div class="absolute right-0 bottom-0 w-72 h-72 bg-red-500 rounded-full blur-3xl"></div>
        </div>
        <div class="relative z-10 flex flex-col md:flex-row items-center gap-8 px-8 py-10">
            <div class="flex-1 space-y-4">
                <p class="inline-flex items-center gap-2 px-3 py-1 bg-white/10 rounded-full text-sm font-semibold uppercase tracking-wide">Sự kiện đang diễn ra</p>
                <h1 class="text-3xl md:text-4xl font-extrabold leading-tight">ăn deal công nghệ, giao nhanh trong ngày</h1>
                <p class="text-gray-200">Chọn sản phẩm yêu thích, thêm vào giỏ và thanh toán chỉ trong vài bước. Flash sale sẽ bổ sung sau để tránh rối.</p>
                <div class="flex flex-wrap gap-3">
                    <a href="/user/product/" class="bg-yellow-400 text-gray-900 font-semibold px-5 py-3 rounded-lg hover:bg-yellow-300 transition shadow">Xem sản phẩm</a>
                    <a href="/user/orders" class="border border-white/30 px-5 py-3 rounded-lg hover:bg-white/10 transition">Theo dõi đơn mua</a>
                </div>
            </div>
            <!-- Carousel container -->
            <div class="flex-1 w-full relative">
                <div class="bg-white/10 backdrop-blur rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm text-gray-200">Sản phẩm khuyến mãi</span>
                        <span class="text-xs bg-white/20 px-3 py-1 rounded-full"><span id="carousel-current">1</span>/<span id="carousel-total" th:text="${#lists.size(bannerProducts)}">5</span></span>
                    </div>
                    <!-- Carousel slides -->
                    <div class="relative">
                        <div id="carousel-container" class="aspect-[16/9] bg-white/5 rounded-lg border border-white/10 flex items-center justify-center overflow-hidden">
                            <img id="carousel-image" src="" alt="Product" class="w-full h-full object-contain p-4">
                        </div>
                        <!-- Navigation buttons -->
                        <button type="button" id="carousel-prev" class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 rounded-full p-2 transition z-20">
                            <i class="fas fa-chevron-left text-white"></i>
                        </button>
                        <button type="button" id="carousel-next" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 rounded-full p-2 transition z-20">
                            <i class="fas fa-chevron-right text-white"></i>
                        </button>
                    </div>
                    <!-- Dot indicators -->
                    <div class="flex justify-center gap-2 mt-4" id="carousel-dots">
                        <!-- Dots sẽ được tạo bởi JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick filters (AJAX) - ẩn khi tìm kiếm -->
    <section th:unless="${isSearchMode}" class="mt-10" aria-label="Bộ lọc nhanh">
        <div class="flex flex-wrap gap-3" id="filter-bar">
            <button class="filter-btn px-4 py-2 rounded-full bg-orange-500 text-white border border-orange-500 shadow-sm" data-category="">Tất cả</button>
            <button class="filter-btn px-4 py-2 rounded-full bg-white border border-gray-200 shadow-sm hover:border-orange-400" th:each="cat : ${categorys}" th:text="${cat.name}" th:data-category="${cat.id}">Category</button>
        </div>
    </section>

    <!-- Flash sale (co the thay bang du lieu that) - ẩn khi tìm kiếm -->
    <section th:unless="${isSearchMode}" class="mt-10 bg-white border border-gray-200 rounded-2xl shadow p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl font-extrabold text-red-600 flex items-center gap-2"><i class="fas fa-bolt"></i> Flash Sale</span>
                <span class="text-sm text-gray-600">Kết thúc sau <span id="fs-timer">02:14:45</span></span>
            </div>
            <a href="#products" class="text-sm text-orange-600 font-semibold hover:text-orange-700">Xem tất cả</a>
        </div>  
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="flash-sale-list">
            <article class="border border-red-100 rounded-xl p-4 bg-white/50">
                <div class="flex items-center gap-3">
                    <img src="https://store.storeimages.cdn-apple.com/8756/as-images.apple.com/is/iphone-15-pro-max-natural-titanium-select-202309?wid=1024&hei=1024" class="w-16 h-16 object-contain" alt="">
                    <div>
                        <p class="font-semibold">iPhone 15 Pro Max</p>
                        <p class="text-red-600 font-bold">19.990.000 đ</p>
                        <p class="text-xs text-gray-500">Đã bán 80%</p>
                    </div>
                </div>
            </article>
            <article class="border border-red-100 rounded-xl p-4 bg-white/50">
                <div class="flex items-center gap-3">
                    <img src="https://cdn.tgdd.vn/Products/Images/44/231244/macbook-air-m1-2020-gray-600x600.jpg" class="w-16 h-16 object-contain" alt="">
                    <div>
                        <p class="font-semibold">MacBook Air M1</p>
                        <p class="text-red-600 font-bold">14.500.000 đ</p>
                        <p class="text-xs text-gray-500">Đã bán 35%</p>
                    </div>
                </div>
            </article>
            <article class="border border-red-100 rounded-xl p-4 bg-white/50">
                <div class="flex items-center gap-3">
                    <img src="https://images.samsung.com/is/image/samsung/p6pim/vn/s24-ultra/gallery/vn-galaxy-s24-s928-sm-s928bzkwxxv-thumb-539297672" class="w-16 h-16 object-contain" alt="">
                    <div>
                        <p class="font-semibold">Galaxy S24 Ultra</p>
                        <p class="text-red-600 font-bold">22.400.000 đ</p>
                        <p class="text-xs text-gray-500">Đã bán 45%</p>
                    </div>
                </div>
            </article>
            <article class="border border-red-100 rounded-xl p-4 bg-white/50">
                <div class="flex items-center gap-3">
                    <img src="https://cdn.tgdd.vn/Products/Images/7264/309731/dong-ho-thong-minh-xiaomi-watch-2-pro-den-thumb-1-600x600.jpg" class="w-16 h-16 object-contain" alt="">
                    <div>
                        <p class="font-semibold">Xiaomi Watch 2 Pro</p>
                        <p class="text-red-600 font-bold">4.500.000 đ</p>
                        <p class="text-xs text-gray-500">Đã bán 15%</p>
                    </div>
                </div>
            </article>
        </div>
    </section>

    <!-- Categories: danh sách loại - ẩn khi tìm kiếm -->
    <section th:unless="${isSearchMode}" class="mt-10" id="categories">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold">Danh mục nổi bật</h2>
                <p class="text-sm text-gray-500">Chọn nhanh theo nhu cầu</p>
            </div>
        </div>
        <div class="relative">
            <button id="catPrev" class="absolute left-1 md:left-2 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white text-gray-700 shadow rounded-full w-9 h-9 flex items-center justify-center backdrop-blur border border-gray-200 disabled:opacity-40 disabled:cursor-not-allowed" aria-label="Lùi danh mục">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex flex-nowrap gap-4 overflow-x-auto no-scrollbar snap-x snap-mandatory scroll-smooth" id="category-grid">
                <div th:each="cat : ${categorys}" class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 text-center hover:-translate-y-1 transition cursor-pointer category-card flex-shrink-0 w-40 sm:w-44 md:w-48 snap-start" th:data-category="${cat.id}">
                    <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center">
                        <i class="fas fa-box"></i>
                    </div>
                    <p class="font-semibold" th:text="${cat.name}">Danh mục</p>
                    <p class="text-xs text-gray-500">Xem sản phẩm</p>
                </div>
            </div>
            <button id="catNext" class="absolute right-1 md:right-2 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white text-gray-700 shadow rounded-full w-9 h-9 flex items-center justify-center backdrop-blur border border-gray-200 disabled:opacity-40 disabled:cursor-not-allowed" aria-label="Tiến danh mục">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </section>

    <!-- Products -->
    <section class="mt-12" id="products">
        <!-- Layout với sidebar khi tìm kiếm -->
        <div th:if="${isSearchMode}" class="flex gap-6">
            <!-- Sidebar bộ lọc -->
            <aside class="w-64 flex-shrink-0 hidden lg:block">
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-5 sticky top-24 space-y-6">
                    <!-- Bộ lọc theo giá -->
                    <div class="border-b border-gray-200 pb-5">
                        <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-dollar-sign text-orange-500"></i>
                            Khoảng giá
                        </h3>
                        <div class="space-y-2 text-sm">
                            <label class="flex items-center gap-2 cursor-pointer hover:text-orange-600">
                                <input type="checkbox" class="rounded" value="0-5000000">
                                <span>Dưới 5 triệu</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:text-orange-600">
                                <input type="checkbox" class="rounded" value="5000000-10000000">
                                <span>5 - 10 triệu</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:text-orange-600">
                                <input type="checkbox" class="rounded" value="10000000-20000000">
                                <span>10 - 20 triệu</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:text-orange-600">
                                <input type="checkbox" class="rounded" value="20000000-999999999">
                                <span>Trên 20 triệu</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Bộ lọc theo đánh giá -->
                    <div class="border-b border-gray-200 pb-5">
                        <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-star text-orange-500"></i>
                            Đánh giá
                        </h3>
                        <div class="space-y-2 text-sm">
                            <label class="flex items-center gap-2 cursor-pointer hover:text-orange-600">
                                <input type="checkbox" class="rounded" value="5">
                                <span class="flex items-center gap-1 text-yellow-500">
                                    <i class="fas fa-star text-xs"></i><i class="fas fa-star text-xs"></i><i class="fas fa-star text-xs"></i><i class="fas fa-star text-xs"></i><i class="fas fa-star text-xs"></i>
                                    <span class="text-gray-600 ml-1">5 sao</span>
                                </span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:text-orange-600">
                                <input type="checkbox" class="rounded" value="4">
                                <span class="flex items-center gap-1 text-yellow-500">
                                    <i class="fas fa-star text-xs"></i><i class="fas fa-star text-xs"></i><i class="fas fa-star text-xs"></i><i class="fas fa-star text-xs"></i><i class="far fa-star text-xs"></i>
                                    <span class="text-gray-600 ml-1">4 sao trở lên</span>
                                </span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer hover:text-orange-600">
                                <input type="checkbox" class="rounded" value="3">
                                <span class="flex items-center gap-1 text-yellow-500">
                                    <i class="fas fa-star text-xs"></i><i class="fas fa-star text-xs"></i><i class="fas fa-star text-xs"></i><i class="far fa-star text-xs"></i><i class="far fa-star text-xs"></i>
                                    <span class="text-gray-600 ml-1">3 sao trở lên</span>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Bộ lọc theo danh mục -->
                    <div class="pb-2">
                        <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-tag text-orange-500"></i>
                            Danh mục
                        </h3>
                        <div class="space-y-2 text-sm max-h-60 overflow-y-auto">
                            <label th:each="cat : ${categorys}" class="flex items-center gap-2 cursor-pointer hover:text-orange-600">
                                <input type="checkbox" class="rounded" th:value="${cat.id}">
                                <span th:text="${cat.name}">Danh mục</span>
                            </label>
                        </div>
                    </div>

                    <!-- Nút xóa bộ lọc -->
                    <button class="w-full py-2 px-4 border border-orange-500 text-orange-500 rounded-lg hover:bg-orange-50 font-medium text-sm">
                        <i class="fas fa-times-circle mr-1"></i> Xóa bộ lọc
                    </button>
                </div>
            </aside>

            <!-- Main content area với sắp xếp -->
            <div class="flex-1">
                <div class="flex items-center justify-between mb-6 bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-600">Sắp xếp theo:</span>
                        <select class="text-sm border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="relevant">Liên quan nhất</option>
                            <option value="newest">Mới nhất</option>
                            <option value="price-asc">Giá: Thấp → Cao</option>
                            <option value="price-desc">Giá: Cao → Thấp</option>
                            <option value="bestseller">Bán chạy</option>
                        </select>
                    </div>
                    <!-- Toggle view button -->
                    <div class="flex items-center gap-2">
                        <button class="p-2 border border-gray-300 rounded hover:bg-gray-50" title="Hiển thị dạng lưới">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="p-2 border border-gray-300 rounded hover:bg-gray-50" title="Hiển thị dạng danh sách">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                <!-- Grid tìm kiếm -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6" id="product-grid" data-empty="Chưa có sản phẩm phù hợp.">
                    <article th:each="product : ${products}" class="product-card bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden hover:-translate-y-1 transition" th:data-id="${product.id}" th:data-name="${product.name}" th:data-price="${product.price}" th:data-image="${product.imageUrl}" th:data-category="${product.category.name}">
                        <div class="relative h-84 bg-gray-50 overflow-hidden">
                            <a th:href="@{/user/product/{id}(id=${product.id})}" class="block w-full h-full">
                                <img th:src="${product.imageUrl}" th:alt="${product.name}" class="w-full h-full object-cover">
                            </a>
                            <span class="absolute top-3 left-3 bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full">Hot</span>
                            <span class="js-discount-badge absolute top-3 right-3 bg-red-600 text-white text-xs font-extrabold px-2.5 py-1 rounded-lg shadow-lg ring-1 ring-white/80">-10%</span>
                        </div>  
                        <div class="p-4 space-y-2">
                            <p class="text-xs uppercase text-gray-500" th:text="${product.category.name}">Danh mục</p>
                            <a th:href="@{/user/product/{id}(id=${product.id})}" class="block font-semibold text-gray-900 line-clamp-2 hover:text-orange-600" th:text="${product.name}">Tên sản phẩm</a>
                            <div class="space-y-1">
                                <div class="flex items-baseline gap-3">
                                    <span class="js-new-price text-lg font-bold text-red-600" th:text="${#numbers.formatDecimal(product.price,0,'COMMA',0,'POINT')} + ' đ'">0 đ</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="js-old-price text-xs text-gray-400 line-through">Giá cũ</span>
                                </div>
                                <div class="js-meta flex items-center gap-2 text-xs text-gray-500"></div>
                            </div>
                            <div class="flex items-center gap-2 pt-2">
                                <button class="btn-add-cart flex-1 bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold py-2 rounded-lg" th:data-id="${product.id}">
                                    Thêm vào giỏ
                                </button>
                                <a th:href="@{/user/product/{id}(id=${product.id})}" class="w-10 h-10 border border-gray-200 rounded-lg flex items-center justify-center hover:border-orange-400" aria-label="Xem chi tiet">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </div>
                    </article>
                </div>

                <div class="text-center mt-8">
                    <button id="btn-load-more" class="px-6 py-3 bg-white border border-gray-200 rounded-full shadow hover:border-orange-400">Tải thêm sản phẩm</button>
                </div>
            </div>
        </div>




        <!-- Layout mặc định khi không tìm kiếm -->
        <div th:unless="${isSearchMode}">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold">Sản phẩm đề xuất</h2>
                    <p class="text-sm text-gray-500">Cập nhật theo xu hướng</p>
                </div>
            </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="product-grid" data-empty="Chưa có sản phẩm phù hợp.">
            <article th:each="product : ${products}" class="product-card bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden hover:-translate-y-1 transition" th:data-id="${product.id}" th:data-name="${product.name}" th:data-price="${product.price}" th:data-image="${product.imageUrl}" th:data-category="${product.category.name}">
                <div class="relative h-72 bg-gray-50 overflow-hidden">
                    <a th:href="@{/user/product/{id}(id=${product.id})}" class="block w-full h-full">
                        <img th:src="${product.imageUrl}" th:alt="${product.name}" class="w-full h-full object-cover">
                    </a>
                    <span class="absolute top-3 left-3 bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full">Hot</span>
                    <span class="js-discount-badge absolute top-3 right-3 bg-red-600 text-white text-xs font-extrabold px-2.5 py-1 rounded-lg shadow-lg ring-1 ring-white/80">-10%</span>
                </div>  
                <div class="p-4 space-y-2">
                    <p class="text-xs uppercase text-gray-500" th:text="${product.category.name}">Danh mục</p>
                    <a th:href="@{/user/product/{id}(id=${product.id})}" class="block font-semibold text-gray-900 line-clamp-2 hover:text-orange-600" th:text="${product.name}">Tên sản phẩm</a>
                    <div class="space-y-1">
                        <div class="flex items-baseline gap-3">
                            <span class="js-new-price text-lg font-bold text-red-600" th:text="${#numbers.formatDecimal(product.price,0,'COMMA',0,'POINT')} + ' đ'">0 đ</span>
                        </div>
                        <div class="flex items-center">
                            <span class="js-old-price text-xs text-gray-400 line-through">Giá cũ</span>
                        </div>
                        <div class="js-meta flex items-center gap-2 text-xs text-gray-500"></div>
                    </div>
                    <div class="flex items-center gap-2 pt-2">
                        <button class="btn-add-cart flex-1 bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold py-2 rounded-lg" th:data-id="${product.id}">
                            Thêm vào giỏ
                        </button>
                        <a th:href="@{/user/product/{id}(id=${product.id})}" class="w-10 h-10 border border-gray-200 rounded-lg flex items-center justify-center hover:border-orange-400" aria-label="Xem chi tiet">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </div>
            </article>
        </div>

            <div class="text-center mt-8">
                <button id="btn-load-more" class="px-6 py-3 bg-white border border-gray-200 rounded-full shadow hover:border-orange-400">Tải thêm sản phẩm</button>
            </div>
        </div>
    </section>

    <!-- Assurance -->
    <section class="mt-14 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center gap-3">
            <i class="fas fa-shield-alt text-orange-500 text-2xl"></i>
            <div>
                <p class="font-semibold">Hàng chính hãng</p>
                <p class="text-sm text-gray-500">Bảo hành từ nhà sản xuất</p>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center gap-3">
            <i class="fas fa-truck text-orange-500 text-2xl"></i>
            <div>
                <p class="font-semibold">Giao nhanh</p>
                <p class="text-sm text-gray-500">Từ 2h tại các thành phố</p>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-4 flex items-center gap-3">
            <i class="fas fa-rotate-left text-orange-500 text-2xl"></i>
            <div>
                <p class="font-semibold">Đổi trả dễ dàng</p>
                <p class="text-sm text-gray-500">Trong 7 ngày nếu có lỗi</p>
            </div>
        </div>
    </section>
</main>

<!-- Footer fragment -->
<div th:replace="~{user/Fragment/Footer :: footer}"></div>

<!-- Toast container -->
<div id="toast" class="hidden fixed top-20 right-4 z-50 max-w-md"></div>

<!-- Hidden carousel data -->
    <div id="carousel-data-holder" style="display:none;">
        <div th:each="product : ${bannerProducts}" class="carousel-item" th:data-id="${product.id}" th:data-image="${product.imageUrl}"></div>
    </div>

<script>

    // Load more & category filter state
    const loadMoreBtn = document.getElementById('btn-load-more');
    let currentPage = 0;
    let currentCategory = '';
    const searchKeyword = new URLSearchParams(window.location.search).get('q') || ''; // Lấy keyword từ URL
    const isSearchMode = searchKeyword.trim().length > 0;

    function toggleLoadMore(show) {
        if (!loadMoreBtn) return;
        loadMoreBtn.style.display = show ? 'inline-flex' : 'none';
    }

    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', () => {
            currentPage++;
            fetchProducts(currentCategory, true, searchKeyword);
        });
    }


    // Hiển thị thông báo toast
    let toastEl = document.getElementById('toast');
    function ensureToast() {
        if (toastEl) return toastEl;
        const el = document.createElement('div');
        el.id = 'toast';
        el.className = 'hidden fixed top-20 right-4 z-50 max-w-md';
        document.body.appendChild(el);
        toastEl = el;
        return el;
    }
    function showToast(message, type = 'success') {
        const el = ensureToast();
        el.innerHTML = `<div class="px-4 py-3 rounded-lg shadow text-white ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}">${message}</div>`;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 2200);
    }

    // Cập nhật số lượng giỏ hàng
    async function updateCartCount() {
        let badge = document.querySelector('[data-cart-count]');
        if (!badge) {
            const cartLink = document.querySelector('a[href="/user/cart"]');
            if (cartLink) {
                badge = document.createElement('span');
                badge.dataset.cartCount = 'true';
                badge.className = 'absolute -top-2 -right-2 bg-yellow-400 text-red-600 text-xs font-bold min-w-[20px] h-5 px-1 rounded-full flex items-center justify-center';
                cartLink.appendChild(badge);
            }
        }
        if (!badge) return;
        try {
            const res = await fetch('/api/cart/count', { credentials: 'same-origin' });
            if (!res.ok) return;
            const data = await res.json();
            badge.textContent = data.count ?? 0;
        } catch (_) { /* silent */ }
    }

    // Thêm vào giỏ hàng
    async function addToCart(productId) {
        try {
            const res = await fetch('/api/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ productId, quantity: 1 })
            });
            if (!res.ok) throw new Error('fail');
            const data = await res.json();
            showToast('Thêm vào giỏ hàng thành công');
            // Cập nhật badge từ response nếu có
            if (data.cartItemCount !== undefined) {
                let badge = document.querySelector('[data-cart-count]');
                if (!badge) {
                    const cartLink = document.querySelector('a[href="/user/cart"]');
                    if (cartLink) {
                        badge = document.createElement('span');
                        badge.dataset.cartCount = 'true';
                        badge.className = 'absolute -top-2 -right-2 bg-yellow-400 text-red-600 text-xs font-bold min-w-[20px] h-5 px-1 rounded-full flex items-center justify-center';
                        cartLink.appendChild(badge);
                    }
                }
                if (badge) badge.textContent = data.cartItemCount;
            } else {
                updateCartCount();
            }
        } catch (e) {
            showToast('Không thể thêm vào giỏ hàng', 'error');
        }
    }

    // Init: Load cart count on page load
    updateCartCount();

    // Xử lý sự kiện khi click nút "Thêm vào giỏ"
    function bindAddToCartButtons(scope = document) {
        scope.querySelectorAll('.btn-add-cart').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                if (id) addToCart(id);
            });
        });
    }
    bindAddToCartButtons();

    // Filter AJAX (expects JSON list)
    const filterBar = document.getElementById('filter-bar');
    const productGrid = document.getElementById('product-grid');

    async function fetchProducts(categoryId = '', append = false, searchQuery = '') {
        try {
            const pageParam = append ? currentPage : 0;
            let url;
            
            // Nếu có từ khóa tìm kiếm, gọi API tìm kiếm
            if (searchQuery.trim()) {
                url = `/api/search?q=${encodeURIComponent(searchQuery)}&page=${pageParam}`;
            } else if (categoryId) {
                url = `/api/products?categoryId=${categoryId}&page=${pageParam}`;
            } else {
                url = `/api/products?page=${pageParam}`;
            }
            
            if (!append) currentPage = pageParam;
            const res = await fetch(url);
            if (!res.ok) throw new Error('fail');
            const items = await res.json();
            if (!append) productGrid.innerHTML = '';
            renderProducts(items, append);
            // Chỉ hiển thị nút "Tải thêm" nếu có ít nhất 1 sản phẩm
            toggleLoadMore(items.length > 0);
        } catch (e) {
            showToast('Khong the tai san pham', 'error');
        }
    }

    // Hiên thị sản phẩm lên lưới
    function renderProducts(items, append = false) {
        if (!productGrid) return;
        if (!items || items.length === 0) {
            if (!append) {
                productGrid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-8">${productGrid.dataset.empty}</div>`;
                toggleLoadMore(false);
            }
            return;
        }
        const cards = items.map(p => `
            <article class="product-card bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden hover:-translate-y-1 transition" data-id="${p.id}" data-name="${p.name}" data-price="${p.price}" data-image="${p.imageUrl}" data-category="${p.categoryName ?? ''}">
                <div class="relative h-48 bg-gray-50 overflow-hidden">
                    <a href="/user/product/${p.id}" class="block w-full h-full">
                        <img src="${p.imageUrl}" alt="${p.name}" class="w-full h-full object-cover">
                    </a>
                    <span class="absolute top-3 left-3 bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full">Hot</span>
                    <span class="js-discount-badge absolute top-3 right-3 bg-red-600 text-white text-xs font-extrabold px-2.5 py-1 rounded-lg shadow-lg ring-1 ring-white/80">-10%</span>
                </div>
                <div class="p-4 space-y-2">
                    <p class="text-xs uppercase text-gray-500">${p.categoryName ?? ''}</p>
                    <a href="/user/product/${p.id}" class="block font-semibold text-gray-900 line-clamp-2 hover:text-orange-600">${p.name}</a>
                    <div class="space-y-1">
                        <div class="flex items-baseline gap-3">
                            <span class="js-new-price text-lg font-bold text-red-600">${p.price}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="js-old-price text-xs text-gray-400 line-through">Giá cũ</span>
                        </div>
                        <div class="js-meta flex items-center gap-2 text-xs text-gray-500"></div>
                    </div>
                    <div class="flex items-center gap-2 pt-2">
                        <button class="btn-add-cart flex-1 bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold py-2 rounded-lg" data-id="${p.id}">Thêm vào giỏ</button>
                        <a href="/user/product/${p.id}" class="w-10 h-10 border border-gray-200 rounded-lg flex items-center justify-center hover:border-orange-400" aria-label="Xem chi tiet">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </div>
            </article>
        `).join('');
        if (append) {
            productGrid.insertAdjacentHTML('beforeend', cards);
        } else {
            productGrid.innerHTML = cards;
        }
        bindAddToCartButtons(productGrid);
        applyRandomPricing(productGrid);
    }

    // Xử lý sự kiện lọc Category
    if (filterBar) {
        filterBar.addEventListener('click', (e) => {
            const btn = e.target.closest('.filter-btn');
            if (!btn) return;
            filterBar.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-orange-500','text-white','border-orange-500'));
            btn.classList.add('bg-orange-500','text-white','border-orange-500');
            currentCategory = btn.dataset.category || '';
            currentPage = 0;
            fetchProducts(currentCategory, false, ''); // Không tìm kiếm khi lọc danh mục
        });
    }

    // Click danh mục ở grid "Danh mục nổi bật"
    const categoryGrid = document.getElementById('category-grid');
    if (categoryGrid) {
        categoryGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.category-card');
            if (!card) return;
            categoryGrid.querySelectorAll('.category-card').forEach(c => c.classList.remove('ring','ring-orange-400','active'));
            card.classList.add('ring','ring-orange-400','active');
            currentCategory = card.dataset.category || '';
            currentPage = 0;
            fetchProducts(currentCategory, false, ''); // Không tìm kiếm khi lọc danh mục
        });
    }

    // Mũi tên trượt danh mục
    const catPrev = document.getElementById('catPrev');
    const catNext = document.getElementById('catNext');
    function updateCatArrows() {
        if (!categoryGrid || !catPrev || !catNext) return;
        const maxScroll = categoryGrid.scrollWidth - categoryGrid.clientWidth;
        const x = categoryGrid.scrollLeft;
        catPrev.disabled = x <= 0;
        catNext.disabled = x >= (maxScroll - 1);
    }
    if (categoryGrid && catPrev && catNext) {
        const step = () => Math.max(200, Math.floor(categoryGrid.clientWidth * 0.9));
        catPrev.addEventListener('click', () => {
            categoryGrid.scrollBy({ left: -step(), behavior: 'smooth' });
        });
        catNext.addEventListener('click', () => {
            categoryGrid.scrollBy({ left: step(), behavior: 'smooth' });
        });
        categoryGrid.addEventListener('scroll', updateCatArrows);
        window.addEventListener('resize', updateCatArrows);
        // Khởi tạo trạng thái nút
        updateCatArrows();
    }

    // Flash sale countdown (demo)
    const fsTimer = document.getElementById('fs-timer');
    let fsSeconds = 2 * 3600 + 14 * 60 + 45;
    function tickFlashSale() {
        if (!fsTimer) return;
        const h = Math.floor(fsSeconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((fsSeconds % 3600) / 60).toString().padStart(2, '0');
        const s = (fsSeconds % 60).toString().padStart(2, '0');
        fsTimer.textContent = `${h}:${m}:${s}`;
        if (fsSeconds > 0) fsSeconds--;
    }
    tickFlashSale();
    setInterval(tickFlashSale, 1000);

    // Định dạng tiền tệ VND
    function formatVND(n) {
        try { return (Math.round(n)).toLocaleString('vi-VN') + ' đ'; } catch (_) { return n + ' đ'; }
    }

    // Áp dụng giảm giá ngẫu nhiên, hiển thị phần trăm giảm, sao và số đã bán
    function applyRandomPricing(scope = document) {
        scope.querySelectorAll('.product-card').forEach(card => {
            const baseStr = card.getAttribute('data-price');
            const base = parseFloat(baseStr);
            if (!base || isNaN(base)) return;
            const discount = Math.floor(Math.random() * 16) + 5; // 5..20%
            const newPrice = Math.round(base * (100 - discount) / 100);

            const newEl = card.querySelector('.js-new-price');
            const oldEl = card.querySelector('.js-old-price');
            const badgeEl = card.querySelector('.js-discount-badge');
            if (newEl) newEl.textContent = formatVND(newPrice);
            if (oldEl) oldEl.textContent = formatVND(base);
            if (badgeEl) badgeEl.textContent = `-${discount}%`;

            const metaEl = card.querySelector('.js-meta');
            if (metaEl) {
                const stars = Math.floor(Math.random() * 3) + 3; // 3..5
                const sold = Math.floor(Math.random() * 401) + 50; // 50..450
                const fullStars = '<i class="fas fa-star"></i>'.repeat(stars);
                const emptyStars = '<i class="far fa-star"></i>'.repeat(5 - stars);
                metaEl.innerHTML = `
                    <span class="flex items-center gap-1 text-yellow-500">${fullStars}${emptyStars}<span class="text-gray-500 ml-1">${stars}.0</span></span>
                    <span class="text-gray-500">• Đã bán ${sold}</span>
                `;
            }
        });
    }

    // Áp dụng cho SSR ban đầu
    applyRandomPricing(document);

    // Khi ở chế độ tìm kiếm, reload dữ liệu từ API để có pagination đúng
    if (isSearchMode && searchKeyword.trim()) {
        currentPage = 0;
        fetchProducts('', false, searchKeyword);
    }

    updateCartCount();

    // ===== CAROUSEL LOGIC (Hero Banner) =====
    console.log('Starting carousel initialization...');
    
    // Lấy dữ liệu từ hidden div
    const carouselData = (() => {
        const items = document.querySelectorAll('#carousel-data-holder .carousel-item');
        const data = Array.from(items).map(item => ({
            id: parseInt(item.dataset.id) || 0,
            imageUrl: item.dataset.image || ''
        })).filter(p => p.imageUrl);
        console.log('Carousel data loaded:', data);
        return data;
    })();

    if (carouselData.length === 0) {
        console.warn('No banner products available');
    } else {
        console.log('Total products:', carouselData.length);
    }

    let currentSlide = 0;
    let autoPlayTimeout;

    const carouselElements = {
        image: document.getElementById('carousel-image'),
        current: document.getElementById('carousel-current'),
        dots: document.getElementById('carousel-dots'),
        prevBtn: document.getElementById('carousel-prev'),
        nextBtn: document.getElementById('carousel-next')
    };

    console.log('Carousel elements found:', Object.keys(carouselElements).length);

    function createDots() {
        if (carouselData.length === 0 || !carouselElements.dots) return;
        carouselElements.dots.innerHTML = carouselData.map((_, i) => 
            `<button class="carousel-dot w-2.5 h-2.5 rounded-full transition cursor-pointer ${i === 0 ? 'bg-orange-500' : 'bg-white/40'}" data-slide="${i}" type="button"></button>`
        ).join('');
        
        document.querySelectorAll('.carousel-dot').forEach(dot => {
            dot.addEventListener('click', (e) => {
                e.preventDefault();
                clearTimeout(autoPlayTimeout);
                const slideIndex = parseInt(dot.dataset.slide);
                console.log('Dot clicked, going to slide:', slideIndex);
                goToSlide(slideIndex);
                startAutoPlay();
            });
        });
        console.log('Dots created:', carouselData.length);
    }

    function updateCarouselImage() {
        if (carouselData.length === 0) return;
        const product = carouselData[currentSlide];
        console.log('Updating to slide:', currentSlide, 'Image:', product.imageUrl);
        
        if (carouselElements.image && product.imageUrl) {
            carouselElements.image.src = product.imageUrl;
            carouselElements.image.alt = `Product ${currentSlide + 1}`;
            console.log('✓ Image loaded:', product.imageUrl);
        }
        
        if (carouselElements.current) {
            carouselElements.current.textContent = currentSlide + 1;
        }
        
        // Update dots styling
        document.querySelectorAll('.carousel-dot').forEach((dot, i) => {
            if (i === currentSlide) {
                dot.classList.remove('bg-white/40');
                dot.classList.add('bg-orange-500');
            } else {
                dot.classList.add('bg-white/40');
                dot.classList.remove('bg-orange-500');
            }
        });
    }

    function goToSlide(n) {
        if (carouselData.length === 0) return;
        currentSlide = ((n % carouselData.length) + carouselData.length) % carouselData.length;
        updateCarouselImage();
    }

    function nextSlide() {
        goToSlide(currentSlide + 1);
    }

    function prevSlide() {
        goToSlide(currentSlide - 1);
    }

    function startAutoPlay() {
        clearTimeout(autoPlayTimeout);
        autoPlayTimeout = setTimeout(() => {
            nextSlide();
            startAutoPlay();
        }, 3000);
    }

    function initCarousel() {
        console.log('initCarousel called with', carouselData.length, 'products');
        if (carouselData.length === 0) {
            console.warn('No banner products available');
            return;
        }
        
        createDots();
        updateCarouselImage();
        
        if (carouselElements.prevBtn) {
            carouselElements.prevBtn.addEventListener('click', (e) => {
                e.preventDefault();
                clearTimeout(autoPlayTimeout);
                prevSlide();
                startAutoPlay();
            });
        }
        
        if (carouselElements.nextBtn) {
            carouselElements.nextBtn.addEventListener('click', (e) => {
                e.preventDefault();
                clearTimeout(autoPlayTimeout);
                nextSlide();
                startAutoPlay();
            });
        }
        
        startAutoPlay();
        console.log('✓ Carousel initialized successfully');
    }

    // Start carousel
    initCarousel();
</script>

</body>
</html>